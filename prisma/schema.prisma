// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  EMPLOYEE
  VALIDATOR
  TEMP_STAFF
  ACCREDITATION_ADDER
  ACCREDITATION_APPROVER
}

enum BillingCycle {
  MONTHLY
  YEARLY
  ONE_TIME
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

enum AssetStatus {
  IN_USE
  SPARE
  REPAIR
  DISPOSED
}

enum AcquisitionType {
  NEW_PURCHASE
  TRANSFERRED
}

enum SupplierStatus {
  PENDING
  APPROVED
  REJECTED
}

// Leave Management Enums
enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum LeaveRequestType {
  FULL_DAY
  HALF_DAY_AM
  HALF_DAY_PM
}

enum LeaveCategory {
  STANDARD // Auto-initialized for all employees (Annual, Unpaid, Compassionate)
  MEDICAL // Medical-related, balance created on request (Sick Leave)
  PARENTAL // Gender-specific, balance created on request (Maternity, Paternity)
  RELIGIOUS // Religious leave, balance created on request (Hajj)
}

enum AccreditationStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  REVOKED
  ISSUED // Temporary - will be migrated to APPROVED
}

// ═══════════════════════════════════════════════════════════════════════════════
// PROJECT MODULE ENUMS
// ═══════════════════════════════════════════════════════════════════════════════

enum ProjectStatus {
  PLANNING
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum ClientType {
  INTERNAL
  EXTERNAL
  SUPPLIER
}

enum BudgetItemStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  DUE
  OVERDUE
  PENDING_REIMBURSEMENT
  CANCELLED
}

enum PaymentTrancheStatus {
  PENDING
  SCHEDULED
  PROCESSING
  PAID
  FAILED
  CANCELLED
}

enum RevenueStatus {
  DRAFT
  INVOICED
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
  WRITTEN_OFF
}

enum AssetCostType {
  FULL_VALUE
  DEPRECIATED
  RENTAL_RATE
  CUSTOM
  NO_COST
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                           String                 @id @default(cuid())
  name                         String?
  email                        String                 @unique
  emailVerified                DateTime?
  image                        String?
  role                         Role                   @default(EMPLOYEE)
  isSystemAccount              Boolean                @default(false) // For shared assets and system users
  accounts                     Account[]
  sessions                     Session[]
  assets                       Asset[]
  subscriptions                Subscription[]
  activityLogs                 ActivityLog[]
  assetHistoryFrom             AssetHistory[]         @relation("AssetHistoryFromUser")
  assetHistoryTo               AssetHistory[]         @relation("AssetHistoryToUser")
  assetHistoryPerformed        AssetHistory[]         @relation("AssetHistoryPerformer")
  subscriptionHistoryPerformed SubscriptionHistory[]  @relation("SubscriptionHistoryPerformer")
  subscriptionHistoryOldUser   SubscriptionHistory[]  @relation("SubscriptionHistoryOldUser")
  subscriptionHistoryNewUser   SubscriptionHistory[]  @relation("SubscriptionHistoryNewUser")
  approvedSuppliers            Supplier[]             @relation("SupplierApprover")
  supplierEngagements          SupplierEngagement[]
  createdAccreditations        Accreditation[]        @relation("AccreditationCreator")
  approvedAccreditations       Accreditation[]        @relation("AccreditationApprover")
  revokedAccreditations        Accreditation[]        @relation("AccreditationRevoker")
  accreditationHistory         AccreditationHistory[] @relation("AccreditationHistoryPerformer")
  accreditationScans           AccreditationScan[]    @relation("AccreditationScans")
  systemSettingsUpdated        SystemSettings[]       @relation("SystemSettingsUpdater")
  hrProfile                    HRProfile?

  // Task Management relations
  ownedBoards         Board[]          @relation("BoardOwner")
  boardMemberships    BoardMember[]
  createdTasks        Task[]           @relation("TaskCreator")
  taskAssignments     TaskAssignee[]   @relation("TaskAssignments")
  assignedTasks       TaskAssignee[]   @relation("TaskAssigner")
  completedChecklists ChecklistItem[]  @relation("ChecklistCompleter")
  taskComments        TaskComment[]    @relation("TaskCommentAuthor")
  taskAttachments     TaskAttachment[] @relation("TaskAttachmentUploader")
  taskHistory         TaskHistory[]    @relation("TaskHistoryPerformer")

  // Purchase Request relations
  purchaseRequests         PurchaseRequest[]        @relation("PurchaseRequester")
  reviewedPurchaseRequests PurchaseRequest[]        @relation("PurchaseReviewer")
  purchaseRequestHistory   PurchaseRequestHistory[] @relation("PurchaseRequestHistoryPerformer")

  // Leave Management relations
  leaveRequests         LeaveRequest[]        @relation("LeaveRequests")
  leaveApprovals        LeaveRequest[]        @relation("LeaveApprovals")
  leaveBalances         LeaveBalance[]
  leaveHistoryPerformed LeaveRequestHistory[] @relation("LeaveHistoryPerformer")

  // Payroll Management relations
  salaryStructure         SalaryStructure?
  salaryHistoryPerformed  SalaryStructureHistory[] @relation("SalaryHistoryPerformer")
  payslips                Payslip[]
  submittedPayrolls       PayrollRun[]             @relation("PayrollSubmitter")
  approvedPayrolls        PayrollRun[]             @relation("PayrollApprover")
  processedPayrolls       PayrollRun[]             @relation("PayrollProcessor")
  paidPayrolls            PayrollRun[]             @relation("PayrollPayer")
  createdPayrolls         PayrollRun[]             @relation("PayrollCreator")
  payrollHistoryPerformed PayrollHistory[]         @relation("PayrollHistoryPerformer")
  employeeLoans           EmployeeLoan[]
  approvedLoans           EmployeeLoan[]           @relation("LoanApprover")
  createdLoans            EmployeeLoan[]           @relation("LoanCreator")
  recordedRepayments      LoanRepayment[]          @relation("RepaymentRecorder")

  // Project Management relations
  managedProjects             Project[]             @relation("ProjectManager")
  createdProjects             Project[]             @relation("ProjectCreator")
  createdBudgetItems          ProjectBudgetItem[]
  createdProjectPayments      ProjectPayment[]
  createdProjectRevenues      ProjectRevenue[]
  createdProjectAssets        ProjectAsset[]
  createdProjectSubscriptions ProjectSubscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Project model removed - projects are now handled separately by accreditation module

model Asset {
  id              String          @id @default(cuid())
  assetTag        String?         @unique // #1 Asset ID/Tag
  type            String // #2 Asset Type (Laptop, Mouse, Monitor, etc.)
  category        String? // #3 Category/Department (IT, Marketing, Engineering, etc.)
  brand           String? // #4 Brand/Manufacturer (Apple, Dell, HP, etc.)
  model           String // #5 Model/Version (MacBook Pro 16", Dell XPS 15, etc.)
  serial          String? // #6 Serial Number
  configuration   String? // #7 Configuration/Specs (16GB RAM, 512GB SSD, etc.)
  purchaseDate    DateTime? // #8 Purchase Date
  warrantyExpiry  DateTime? // #9 Warranty Expiry
  supplier        String? // #10 Supplier/Vendor (where purchased from)
  invoiceNumber   String? // #12 Invoice/PO Number
  assignedUserId  String? // #13 Assigned To/User
  assignedUser    User?           @relation(fields: [assignedUserId], references: [id])
  assignmentDate  String? // When the asset was assigned to current user
  status          AssetStatus     @default(IN_USE) // #14 Status/Condition
  acquisitionType AcquisitionType @default(NEW_PURCHASE) // #15 Asset Movement (New/Transferred)
  transferNotes   String? // Notes for transferred assets
  price           Decimal? // #16 Cost/Value
  priceCurrency   String?         @default("QAR")
  priceQAR        Decimal?

  // Additional fields
  notes    String? // General notes/remarks about the asset
  location String? // Physical location of the asset (Office, Building, Room, etc.)

  // Relations & Metadata
  history            AssetHistory[]
  maintenanceRecords MaintenanceRecord[]
  projectAllocations ProjectAsset[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@index([warrantyExpiry])
  @@index([brand])
  @@index([model])
  @@index([type])
  @@index([serial])
  @@index([assetTag])
}

enum AssetHistoryAction {
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  LOCATION_CHANGED
  CREATED
  UPDATED
}

model AssetHistory {
  id             String             @id @default(cuid())
  assetId        String
  asset          Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  action         AssetHistoryAction
  fromUserId     String?
  fromUser       User?              @relation("AssetHistoryFromUser", fields: [fromUserId], references: [id])
  toUserId       String?
  toUser         User?              @relation("AssetHistoryToUser", fields: [toUserId], references: [id])
  fromStatus     AssetStatus?
  toStatus       AssetStatus?
  fromLocation   String?
  toLocation     String?
  notes          String?
  performedBy    String?
  performer      User?              @relation("AssetHistoryPerformer", fields: [performedBy], references: [id])
  assignmentDate DateTime? // When asset was assigned (for ASSIGNED action)
  returnDate     DateTime? // When asset was returned (for UNASSIGNED action)
  createdAt      DateTime           @default(now())

  @@index([assetId])
  @@index([createdAt])
  @@index([toUserId])
}

model Subscription {
  id                    String                @id @default(cuid())
  serviceName           String
  category              String?
  accountId             String?
  purchaseDate          DateTime?
  renewalDate           DateTime?
  billingCycle          BillingCycle
  costPerCycle          Decimal?
  costCurrency          String?               @default("QAR")
  costQAR               Decimal?
  vendor                String?
  status                SubscriptionStatus    @default(ACTIVE)
  assignedUserId        String?
  assignedUser          User?                 @relation(fields: [assignedUserId], references: [id])
  autoRenew             Boolean               @default(true)
  paymentMethod         String?
  notes                 String?
  lastActiveRenewalDate DateTime? // Track last renewal before cancel
  cancelledAt           DateTime? // When it was cancelled
  reactivatedAt         DateTime? // When it was last reactivated
  history               SubscriptionHistory[]
  projectAllocations    ProjectSubscription[]
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt

  @@index([renewalDate])
  @@index([status])
  @@index([category])
  @@index([serviceName])
  @@index([vendor])
  @@index([accountId])
}

enum SubscriptionHistoryAction {
  CREATED
  REACTIVATED
  CANCELLED
  RENEWED
  REASSIGNED
}

model SubscriptionHistory {
  id               String                    @id @default(cuid())
  subscriptionId   String
  subscription     Subscription              @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  action           SubscriptionHistoryAction
  oldStatus        SubscriptionStatus?
  newStatus        SubscriptionStatus?
  oldRenewalDate   DateTime?
  newRenewalDate   DateTime?
  reactivationDate DateTime? // Date when service was reactivated
  assignmentDate   DateTime? // Date when user was assigned/reassigned
  oldUserId        String? // Previous assigned user
  newUserId        String? // New assigned user
  oldUser          User?                     @relation("SubscriptionHistoryOldUser", fields: [oldUserId], references: [id])
  newUser          User?                     @relation("SubscriptionHistoryNewUser", fields: [newUserId], references: [id])
  notes            String?
  performedBy      String?
  performer        User?                     @relation("SubscriptionHistoryPerformer", fields: [performedBy], references: [id])
  createdAt        DateTime                  @default(now())

  @@index([subscriptionId])
  @@index([createdAt])
}

model ActivityLog {
  id          String   @id @default(cuid())
  actorUserId String?
  actorUser   User?    @relation(fields: [actorUserId], references: [id])
  action      String
  entityType  String?
  entityId    String?
  payload     Json?
  at          DateTime @default(now())

  @@index([actorUserId])
  @@index([at])
}

model MaintenanceRecord {
  id              String   @id @default(cuid())
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  maintenanceDate DateTime
  notes           String?
  performedBy     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([assetId])
  @@index([maintenanceDate])
}

model Supplier {
  id                     String               @id @default(cuid())
  suppCode               String?              @unique // Auto-generated SUPP-XXXX on approval
  name                   String
  category               String // Material category
  address                String?
  city                   String?
  country                String?
  website                String?
  establishmentYear      Int?
  primaryContactName     String?
  primaryContactTitle    String?
  primaryContactEmail    String?
  primaryContactMobile   String?
  secondaryContactName   String?
  secondaryContactTitle  String?
  secondaryContactEmail  String?
  secondaryContactMobile String?
  paymentTerms           String?
  additionalInfo         String? // Additional information (portfolio, certifications, etc.)
  status                 SupplierStatus       @default(PENDING)
  rejectionReason        String?
  approvedAt             DateTime?
  approvedById           String?
  approvedBy             User?                @relation("SupplierApprover", fields: [approvedById], references: [id])
  engagements            SupplierEngagement[]
  projects               Project[]
  budgetItems            ProjectBudgetItem[]
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt

  @@index([status])
  @@index([suppCode])
  @@index([createdAt])
  @@index([name])
  @@index([category])
}

model SupplierEngagement {
  id          String   @id @default(cuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  date        DateTime
  notes       String
  rating      Int? // 1-5 star rating (optional)
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([supplierId])
  @@index([date])
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model AccreditationProject {
  id   String  @id @default(cuid())
  name String  @default("Unnamed Project")
  code String? @unique

  // Phase dates (sequential)
  bumpInStart  DateTime
  bumpInEnd    DateTime
  liveStart    DateTime
  liveEnd      DateTime
  bumpOutStart DateTime
  bumpOutEnd   DateTime

  // Project-specific access groups (JSON array)
  accessGroups Json // ["VIP", "VVIP", "Organiser", "Contractor", "Medical", "Security", "Media"]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accreditations Accreditation[]

  // Link to Project module
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  @@index([isActive]) // For filtering active projects
  @@index([projectId])
  @@index([bumpInStart]) // For date-based queries
  @@index([liveStart]) // For date-based queries
  @@index([code]) // For project code lookups
}

model Accreditation {
  id                  String @id @default(cuid())
  accreditationNumber String @unique // Auto-generated ACC-XXXX

  // Personal Information
  firstName       String
  lastName        String
  organization    String
  jobTitle        String
  accessGroup     String
  profilePhotoUrl String? // Supabase storage path

  // Identification (Either QID OR Passport+Hayya)
  qidNumber       String?
  qidExpiry       DateTime?
  passportNumber  String?
  passportCountry String? // Country of passport issuance
  passportExpiry  DateTime?
  hayyaVisaNumber String?
  hayyaVisaExpiry DateTime?

  // Access Validity Periods (within project phases)
  hasBumpInAccess Boolean   @default(false)
  bumpInStart     DateTime?
  bumpInEnd       DateTime?

  hasLiveAccess Boolean   @default(false)
  liveStart     DateTime?
  liveEnd       DateTime?

  hasBumpOutAccess Boolean   @default(false)
  bumpOutStart     DateTime?
  bumpOutEnd       DateTime?

  // Workflow
  status      AccreditationStatus @default(DRAFT)
  qrCodeToken String?             @unique // For verification URL
  qrCodeImage String? // Cached base64 QR code image

  // Relations
  projectId String
  project   AccreditationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User   @relation("AccreditationCreator", fields: [createdById], references: [id])

  approvedById String?
  approvedBy   User?     @relation("AccreditationApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  revokedById      String?
  revokedBy        User?     @relation("AccreditationRevoker", fields: [revokedById], references: [id])
  revokedAt        DateTime?
  revocationReason String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history AccreditationHistory[]
  scans   AccreditationScan[]

  @@index([projectId])
  @@index([status])
  @@index([accreditationNumber])
  @@index([qrCodeToken])
  @@index([accessGroup])
  @@index([firstName])
  @@index([lastName])
  @@index([organization])
  @@index([createdAt])
  @@index([qidNumber]) // For duplicate detection
  @@index([passportNumber]) // For duplicate detection
  @@index([status, projectId]) // Composite for filtered queries
  @@index([createdAt, status]) // For approval queue sorting
}

model AccreditationHistory {
  id              String        @id @default(cuid())
  accreditationId String
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)

  action    String // CREATED, SUBMITTED, APPROVED, REJECTED, UPDATED
  oldStatus AccreditationStatus?
  newStatus AccreditationStatus?
  changes   Json? // Store field changes
  notes     String?

  performedById String
  performedBy   User   @relation("AccreditationHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([accreditationId])
  @@index([createdAt])
}

model AccreditationScan {
  id              String        @id @default(cuid())
  accreditationId String
  accreditation   Accreditation @relation(fields: [accreditationId], references: [id], onDelete: Cascade)

  scannedById String
  scannedBy   User   @relation("AccreditationScans", fields: [scannedById], references: [id])

  scannedAt   DateTime @default(now())
  location    String? // Optional: Physical location where scanned
  device      String? // Optional: Device info (user agent)
  ipAddress   String? // Optional: IP address
  wasValid    Boolean // Whether the accreditation was valid at scan time
  validPhases Json? // Which phases were active ["BUMP_IN", "LIVE", "BUMP_OUT"]
  notes       String? // Optional notes from scanner

  @@index([accreditationId])
  @@index([scannedById])
  @@index([scannedAt])
  @@index([wasValid])
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedBy String?
  updater   User?    @relation("SystemSettingsUpdater", fields: [updatedBy], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

model HRProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Personal Information
  dateOfBirth   DateTime?
  gender        String? // Male/Female/Other
  maritalStatus String? // Single/Married/Divorced/Widowed
  nationality   String?

  // Contact Information
  qatarMobile        String? // 8-digit number (prefix +974 hardcoded in UI)
  otherMobileCode    String? @default("+961") // Country code (Lebanon default)
  otherMobileNumber  String?
  personalEmail      String?
  // workEmail from User.email (read-only)
  qatarZone          String?
  qatarStreet        String?
  qatarBuilding      String?
  qatarUnit          String?
  homeCountryAddress String? // textarea

  // Emergency Contacts - Local (Qatar)
  localEmergencyName      String?
  localEmergencyRelation  String?
  localEmergencyPhoneCode String? @default("+974")
  localEmergencyPhone     String?

  // Emergency Contacts - Home Country
  homeEmergencyName      String?
  homeEmergencyRelation  String?
  homeEmergencyPhoneCode String? @default("+961")
  homeEmergencyPhone     String?

  // Identification & Legal
  qidNumber        String?
  qidExpiry        DateTime?
  passportNumber   String?
  passportExpiry   DateTime?
  // passportCountry removed - QID serves as unique identifier
  // healthCardNumber removed - QID serves as unique identifier
  healthCardExpiry DateTime?
  sponsorshipType  String? // Company/Family/Work Permit

  // Employment Information
  employeeId              String? // Admin-only editable
  designation             String?
  dateOfJoining           DateTime?
  hajjLeaveTaken          Boolean   @default(false) // Qatar law: Hajj leave can only be taken once during employment
  bypassNoticeRequirement Boolean   @default(false) // Admin override: bypass advance notice requirements for leave requests

  // Bank & Payroll
  bankName String?
  iban     String?

  // Education
  highestQualification String?
  specialization       String?
  institutionName      String?
  graduationYear       Int?

  // Documents (Supabase storage URLs)
  qidUrl          String?
  passportCopyUrl String?
  photoUrl        String?
  contractCopyUrl String?

  // Additional Info
  hasDrivingLicense    Boolean   @default(false)
  // licenseNumber removed - QID serves as unique identifier
  licenseExpiry        DateTime?
  languagesKnown       String? // JSON array stored as string
  skillsCertifications String? // JSON array stored as string

  // Onboarding tracking
  onboardingStep     Int     @default(0) // Current step in wizard (0-7)
  onboardingComplete Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  changeRequests ProfileChangeRequest[]

  @@index([qidNumber])
  @@index([passportNumber])
  @@index([employeeId])
}

enum ProfileChangeRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ===== Task Management Module Enums =====

enum BoardMemberRole {
  OWNER
  ADMIN
  MEMBER
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskHistoryAction {
  CREATED
  UPDATED
  MOVED
  ASSIGNED
  UNASSIGNED
  COMPLETED
  REOPENED
  COMMENTED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  CHECKLIST_UPDATED
}

// ===== Purchase Request Module Enums =====

enum PurchaseRequestStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  COMPLETED
}

enum PurchaseRequestPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum PurchaseType {
  HARDWARE
  SOFTWARE_SUBSCRIPTION
  SERVICES
  OFFICE_SUPPLIES
  MARKETING
  TRAVEL
  TRAINING
  OTHER
}

enum CostType {
  OPERATING_COST
  PROJECT_COST
}

enum PaymentMode {
  BANK_TRANSFER
  CREDIT_CARD
  CASH
  CHEQUE
  INTERNAL_TRANSFER
}

model ProfileChangeRequest {
  id          String    @id @default(cuid())
  hrProfileId String
  hrProfile   HRProfile @relation(fields: [hrProfileId], references: [id], onDelete: Cascade)

  // Request details
  description String // What changes the user is requesting
  status      ProfileChangeRequestStatus @default(PENDING)

  // Resolution
  resolvedById  String?
  resolvedAt    DateTime?
  resolverNotes String? // Admin notes when resolving

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hrProfileId])
  @@index([status])
  @@index([createdAt])
}

// ===== Task Management Module Models =====

model Board {
  id          String  @id @default(cuid())
  title       String
  description String?
  ownerId     String
  owner       User    @relation("BoardOwner", fields: [ownerId], references: [id])

  isArchived Boolean @default(false)

  members BoardMember[]
  columns TaskColumn[]
  labels  TaskLabel[]

  // Link to Project module
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([ownerId])
  @@index([isArchived])
  @@index([projectId])
  @@index([createdAt])
}

model BoardMember {
  id      String          @id @default(cuid())
  boardId String
  board   Board           @relation(fields: [boardId], references: [id], onDelete: Cascade)
  userId  String
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  role    BoardMemberRole @default(MEMBER)

  joinedAt DateTime @default(now())

  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
}

model TaskColumn {
  id       String @id @default(cuid())
  boardId  String
  board    Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  title    String
  position Int    @default(0)

  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([boardId])
  @@index([position])
}

model Task {
  id       String     @id @default(cuid())
  columnId String
  column   TaskColumn @relation(fields: [columnId], references: [id], onDelete: Cascade)

  title       String
  description String?
  position    Int     @default(0)

  priority TaskPriority @default(MEDIUM)
  dueDate  DateTime?

  isCompleted Boolean   @default(false)
  completedAt DateTime?

  createdById String
  createdBy   User   @relation("TaskCreator", fields: [createdById], references: [id])

  assignees   TaskAssignee[]
  labels      TaskLabelAssignment[]
  checklist   ChecklistItem[]
  comments    TaskComment[]
  attachments TaskAttachment[]
  history     TaskHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([columnId])
  @@index([position])
  @@index([dueDate])
  @@index([priority])
  @@index([isCompleted])
  @@index([createdById])
  @@index([createdAt])
}

model TaskAssignee {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId String
  user   User   @relation("TaskAssignments", fields: [userId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())
  assignedBy String?
  assigner   User?    @relation("TaskAssigner", fields: [assignedBy], references: [id])

  @@unique([taskId, userId])
  @@index([taskId])
  @@index([userId])
}

model TaskLabel {
  id      String @id @default(cuid())
  boardId String
  board   Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)

  name  String
  color String @default("#3b82f6")

  tasks TaskLabelAssignment[]

  createdAt DateTime @default(now())

  @@unique([boardId, name])
  @@index([boardId])
}

model TaskLabelAssignment {
  id      String    @id @default(cuid())
  taskId  String
  task    Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  labelId String
  label   TaskLabel @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([taskId, labelId])
  @@index([taskId])
  @@index([labelId])
}

model ChecklistItem {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  title       String
  isCompleted Boolean @default(false)
  position    Int     @default(0)

  completedAt DateTime?
  completedBy String?
  completer   User?     @relation("ChecklistCompleter", fields: [completedBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([position])
}

model TaskComment {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  content String

  authorId String
  author   User   @relation("TaskCommentAuthor", fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([authorId])
  @@index([createdAt])
}

model TaskAttachment {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  fileName    String
  fileSize    Int
  mimeType    String
  storagePath String

  uploadedById String
  uploadedBy   User   @relation("TaskAttachmentUploader", fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([uploadedById])
}

model TaskHistory {
  id     String @id @default(cuid())
  taskId String
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)

  action  TaskHistoryAction
  changes Json?

  performedById String
  performedBy   User   @relation("TaskHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([performedById])
  @@index([createdAt])
}

// ===== Purchase Request Module Models =====

model PurchaseRequest {
  id              String                  @id @default(cuid())
  referenceNumber String                  @unique // BCE-PR-YYMM-XXXX
  requestDate     DateTime                @default(now())
  status          PurchaseRequestStatus   @default(PENDING)
  priority        PurchaseRequestPriority @default(MEDIUM)

  // Requester info (auto-populated from logged-in user)
  requesterId String
  requester   User   @relation("PurchaseRequester", fields: [requesterId], references: [id])

  // Request details
  title         String
  description   String?
  justification String? // Business justification
  neededByDate  DateTime? // When items are needed

  // Purchase Type & Cost Details (from prototype)
  purchaseType PurchaseType @default(OTHER)
  costType     CostType     @default(OPERATING_COST)
  projectName  String? // Required when costType is PROJECT_COST
  paymentMode  PaymentMode  @default(BANK_TRANSFER)

  // Vendor Details
  vendorName    String?
  vendorContact String?
  vendorEmail   String?

  // Additional Notes
  additionalNotes String?

  // Totals
  totalAmount        Decimal  @db.Decimal(12, 2)
  currency           String   @default("QAR")
  totalAmountQAR     Decimal? @db.Decimal(12, 2)
  totalOneTime       Decimal? @db.Decimal(12, 2) // One-time costs total
  totalMonthly       Decimal? @db.Decimal(12, 2) // Monthly recurring total
  totalContractValue Decimal? @db.Decimal(12, 2) // Total contract value

  // Approval workflow
  reviewedById String?
  reviewedBy   User?     @relation("PurchaseReviewer", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?

  // Completion
  completedAt     DateTime?
  completionNotes String?

  // Link to Project module
  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  // Relations
  items       PurchaseRequestItem[]
  history     PurchaseRequestHistory[]
  budgetItems ProjectBudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([requesterId])
  @@index([status])
  @@index([referenceNumber])
  @@index([createdAt])
  @@index([purchaseType])
  @@index([costType])
  @@index([projectId])
}

model PurchaseRequestItem {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  itemNumber    Int // Line item number (1, 2, 3...)
  description   String
  quantity      Int      @default(1)
  unitPrice     Decimal  @db.Decimal(12, 2)
  currency      String   @default("QAR")
  unitPriceQAR  Decimal? @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2) // quantity * unitPrice
  totalPriceQAR Decimal? @db.Decimal(12, 2)

  // Subscription/recurring fields (for SOFTWARE_SUBSCRIPTION type)
  billingCycle   BillingCycle @default(ONE_TIME) // ONE_TIME, MONTHLY, YEARLY
  durationMonths Int? // Duration in months (for monthly billing)
  amountPerCycle Decimal?     @db.Decimal(12, 2) // Recurring cost per cycle

  // Product details
  productUrl String? // Product link URL

  category String? // IT Equipment, Office Supplies, etc.
  supplier String? // Preferred supplier
  notes    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([purchaseRequestId])
  @@index([billingCycle])
}

model PurchaseRequestHistory {
  id                String          @id @default(cuid())
  purchaseRequestId String
  purchaseRequest   PurchaseRequest @relation(fields: [purchaseRequestId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, ITEM_ADDED, ITEM_REMOVED
  previousStatus PurchaseRequestStatus?
  newStatus      PurchaseRequestStatus?

  performedById String
  performedBy   User   @relation("PurchaseRequestHistoryPerformer", fields: [performedById], references: [id])

  details String? // JSON or text description of changes

  createdAt DateTime @default(now())

  @@index([purchaseRequestId])
  @@index([performedById])
  @@index([createdAt])
}

// ===== Leave Management Module Models =====

model LeaveType {
  id                  String  @id @default(cuid())
  name                String  @unique // Annual, Sick, Maternity, Hajj, Paternity, Unpaid, Compassionate
  description         String?
  color               String  @default("#3B82F6") // For calendar display
  defaultDays         Int     @default(0) // Default annual entitlement
  requiresApproval    Boolean @default(true)
  requiresDocument    Boolean @default(false) // Medical certificate etc.
  isPaid              Boolean @default(true)
  isActive            Boolean @default(true)
  maxConsecutiveDays  Int? // Max consecutive days allowed
  minNoticeDays       Int     @default(0) // Advance notice required
  allowCarryForward   Boolean @default(false)
  maxCarryForwardDays Int?

  // Qatar Labor Law Fields
  minimumServiceMonths    Int           @default(0) // Minimum months of service required (e.g., 3 for sick, 12 for annual/Hajj)
  isOnceInEmployment      Boolean       @default(false) // Can only use once (Hajj leave)
  serviceBasedEntitlement Json? // Service-based days: {"12": 21, "60": 28} (months: days) for annual leave
  payTiers                Json? // For sick leave: [{"days": 14, "payPercent": 100}, {"days": 28, "payPercent": 50}, {"days": 42, "payPercent": 0}]
  category                LeaveCategory @default(STANDARD) // STANDARD auto-init, others admin-assigned
  genderRestriction       String? // "MALE", "FEMALE", or null for any
  accrualBased            Boolean       @default(false) // If true, entitlement accrues monthly

  leaveRequests LeaveRequest[]
  leaveBalances LeaveBalance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([category])
}

model LeaveBalance {
  id              String    @id @default(cuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId     String
  leaveType       LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  year            Int // Year for balance
  entitlement     Decimal   @default(0) // Total days entitled
  used            Decimal   @default(0) // Days used
  pending         Decimal   @default(0) // Days in pending requests
  carriedForward  Decimal   @default(0) // From previous year
  adjustment      Decimal   @default(0) // Manual adjustments (+/-)
  adjustmentNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, leaveTypeId, year])
  @@index([userId])
  @@index([leaveTypeId])
  @@index([year])
}

model LeaveRequest {
  id            String           @id @default(cuid())
  requestNumber String           @unique // Auto-generated LR-XXXXX
  userId        String
  user          User             @relation("LeaveRequests", fields: [userId], references: [id], onDelete: Cascade)
  leaveTypeId   String
  leaveType     LeaveType        @relation(fields: [leaveTypeId], references: [id])
  startDate     DateTime
  endDate       DateTime
  requestType   LeaveRequestType @default(FULL_DAY)
  totalDays     Decimal // Calculated working days
  reason        String?
  documentUrl   String? // Supporting document

  status LeaveStatus @default(PENDING)

  // Approval
  approverId    String?
  approver      User?     @relation("LeaveApprovals", fields: [approverId], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  // Rejection
  rejectedAt      DateTime?
  rejectionReason String?

  // Cancellation
  cancelledAt        DateTime?
  cancellationReason String?

  // Emergency contact during leave
  emergencyContact String?
  emergencyPhone   String?

  history LeaveRequestHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

model LeaveRequestHistory {
  id             String       @id @default(cuid())
  leaveRequestId String
  leaveRequest   LeaveRequest @relation(fields: [leaveRequestId], references: [id], onDelete: Cascade)

  action    String // CREATED, SUBMITTED, APPROVED, REJECTED, CANCELLED, UPDATED
  oldStatus LeaveStatus?
  newStatus LeaveStatus?
  changes   Json?
  notes     String?

  performedById String
  performedBy   User   @relation("LeaveHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([leaveRequestId])
  @@index([createdAt])
}

// ===== Payroll Management Module Enums =====

enum PayrollStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PROCESSED
  PAID
  CANCELLED
}

enum LoanStatus {
  ACTIVE
  PAUSED
  COMPLETED
  WRITTEN_OFF
}

enum DeductionType {
  UNPAID_LEAVE
  LOAN_REPAYMENT
  ADVANCE_DEDUCTION
  OTHER
}

// ===== Payroll Management Module Models =====

model SalaryStructure {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Core salary components (all stored in QAR)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @default(0) @db.Decimal(12, 2)
  transportAllowance     Decimal @default(0) @db.Decimal(12, 2)
  foodAllowance          Decimal @default(0) @db.Decimal(12, 2)
  phoneAllowance         Decimal @default(0) @db.Decimal(12, 2)
  otherAllowances        Decimal @default(0) @db.Decimal(12, 2)
  otherAllowancesDetails String? // JSON: [{ name, amount }]

  // Total calculated monthly salary
  grossSalary Decimal @db.Decimal(12, 2)

  // Currency (for reference, values stored in QAR)
  currency String @default("QAR")

  // Effective dates
  effectiveFrom DateTime
  effectiveTo   DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  history SalaryStructureHistory[]

  @@index([userId])
  @@index([effectiveFrom])
  @@index([isActive])
}

model SalaryStructureHistory {
  id                String          @id @default(cuid())
  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  action         String // CREATED, UPDATED, DEACTIVATED
  changes        Json? // Field changes
  previousValues Json? // Previous salary values
  notes          String?

  performedById String
  performedBy   User   @relation("SalaryHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([salaryStructureId])
  @@index([createdAt])
}

model PayrollRun {
  id              String @id @default(cuid())
  referenceNumber String @unique // PAY-YYYY-MM-XXX

  // Period
  year        Int
  month       Int // 1-12
  periodStart DateTime
  periodEnd   DateTime

  // Status workflow
  status PayrollStatus @default(DRAFT)

  // Totals
  totalGross      Decimal @db.Decimal(14, 2)
  totalDeductions Decimal @db.Decimal(14, 2)
  totalNet        Decimal @db.Decimal(14, 2)
  employeeCount   Int     @default(0)

  // WPS
  wpsFileGenerated Boolean   @default(false)
  wpsFileUrl       String?
  wpsGeneratedAt   DateTime?

  // Workflow
  submittedById String?
  submittedBy   User?     @relation("PayrollSubmitter", fields: [submittedById], references: [id])
  submittedAt   DateTime?

  approvedById  String?
  approvedBy    User?     @relation("PayrollApprover", fields: [approvedById], references: [id])
  approvedAt    DateTime?
  approverNotes String?

  processedById String?
  processedBy   User?     @relation("PayrollProcessor", fields: [processedById], references: [id])
  processedAt   DateTime?

  paidById         String?
  paidBy           User?     @relation("PayrollPayer", fields: [paidById], references: [id])
  paidAt           DateTime?
  paymentReference String?

  createdById String
  createdBy   User   @relation("PayrollCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  payslips Payslip[]
  history  PayrollHistory[]

  @@unique([year, month])
  @@index([status])
  @@index([year, month])
  @@index([referenceNumber])
}

model PayrollHistory {
  id           String     @id @default(cuid())
  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  action         String // CREATED, STATUS_CHANGED, UPDATED, WPS_GENERATED
  previousStatus PayrollStatus?
  newStatus      PayrollStatus?
  changes        Json?
  notes          String?

  performedById String
  performedBy   User   @relation("PayrollHistoryPerformer", fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([payrollRunId])
  @@index([createdAt])
}

model Payslip {
  id            String @id @default(cuid())
  payslipNumber String @unique // PS-YYYY-MM-XXXXX

  payrollRunId String
  payrollRun   PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Salary Components (snapshot from SalaryStructure)
  basicSalary            Decimal @db.Decimal(12, 2)
  housingAllowance       Decimal @db.Decimal(12, 2)
  transportAllowance     Decimal @db.Decimal(12, 2)
  foodAllowance          Decimal @db.Decimal(12, 2)
  phoneAllowance         Decimal @db.Decimal(12, 2)
  otherAllowances        Decimal @db.Decimal(12, 2)
  otherAllowancesDetails String?

  grossSalary Decimal @db.Decimal(12, 2)

  // Deductions
  totalDeductions Decimal @db.Decimal(12, 2)

  // Net
  netSalary Decimal @db.Decimal(12, 2)

  // Payment Info (from HR Profile)
  bankName String?
  iban     String?

  // WPS Info (from HR Profile)
  qidNumber String?

  // Status
  isPaid Boolean   @default(false)
  paidAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  deductions PayslipDeduction[]

  @@unique([payrollRunId, userId])
  @@index([payrollRunId])
  @@index([userId])
  @@index([payslipNumber])
}

model PayslipDeduction {
  id        String  @id @default(cuid())
  payslipId String
  payslip   Payslip @relation(fields: [payslipId], references: [id], onDelete: Cascade)

  type        DeductionType
  description String
  amount      Decimal       @db.Decimal(12, 2)

  // Reference to related entities
  leaveRequestId String? // If UNPAID_LEAVE
  loanId         String? // If LOAN_REPAYMENT
  advanceId      String? // If ADVANCE_DEDUCTION

  createdAt DateTime @default(now())

  @@index([payslipId])
  @@index([type])
}

model EmployeeLoan {
  id         String @id @default(cuid())
  loanNumber String @unique // LOAN-XXXXX

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Loan Details
  type        String // LOAN, ADVANCE
  description String

  // Amounts
  principalAmount  Decimal @db.Decimal(12, 2)
  totalAmount      Decimal @db.Decimal(12, 2) // Including any interest/fees
  monthlyDeduction Decimal @db.Decimal(12, 2)

  // Repayment tracking
  totalPaid       Decimal @default(0) @db.Decimal(12, 2)
  remainingAmount Decimal @db.Decimal(12, 2)

  // Schedule
  startDate        DateTime // When deductions start
  endDate          DateTime? // Expected end date
  installments     Int // Number of monthly installments
  installmentsPaid Int       @default(0)

  status LoanStatus @default(ACTIVE)

  // Approval
  approvedById String?
  approvedBy   User?     @relation("LoanApprover", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  notes String?

  createdById String
  createdBy   User   @relation("LoanCreator", fields: [createdById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  repayments LoanRepayment[]

  @@index([userId])
  @@index([status])
  @@index([loanNumber])
}

model LoanRepayment {
  id     String       @id @default(cuid())
  loanId String
  loan   EmployeeLoan @relation(fields: [loanId], references: [id], onDelete: Cascade)

  amount    Decimal @db.Decimal(12, 2)
  payslipId String? // Link to payslip if deducted from salary

  // Payment details
  paymentDate   DateTime
  paymentMethod String // SALARY_DEDUCTION, CASH, BANK_TRANSFER
  reference     String?

  notes String?

  recordedById String
  recordedBy   User   @relation("RepaymentRecorder", fields: [recordedById], references: [id])

  createdAt DateTime @default(now())

  @@index([loanId])
  @@index([paymentDate])
}

// ═══════════════════════════════════════════════════════════════════════════════
// PROJECT MODULE - Cross-cutting financial entity
// ═══════════════════════════════════════════════════════════════════════════════

model Project {
  id          String        @id @default(cuid())
  code        String        @unique // "PRJ-2025-0001" or custom like "MCITFN25"
  name        String
  description String?
  status      ProjectStatus @default(PLANNING)

  // Client & Contract
  clientType    ClientType @default(INTERNAL)
  supplierId    String?
  supplier      Supplier?  @relation(fields: [supplierId], references: [id])
  clientName    String? // For external clients not in Supplier table
  clientContact String?

  // Revenue (Contract Value)
  contractValue    Decimal? @db.Decimal(12, 2)
  contractCurrency String   @default("QAR")
  contractValueQAR Decimal? @db.Decimal(12, 2)

  // Budget
  budgetAmount    Decimal? @db.Decimal(12, 2)
  budgetCurrency  String   @default("QAR")
  budgetAmountQAR Decimal? @db.Decimal(12, 2)

  // Timeline
  startDate DateTime?
  endDate   DateTime?

  // Ownership
  managerId       String
  manager         User    @relation("ProjectManager", fields: [managerId], references: [id])
  documentHandler String? // Name of person handling documentation

  // Budget tracking relations
  budgetCategories ProjectBudgetCategory[]
  budgetItems      ProjectBudgetItem[]
  revenues         ProjectRevenue[]

  // Cross-module relations (optional links)
  purchaseRequests        PurchaseRequest[]
  assetAllocations        ProjectAsset[]
  subscriptionAllocations ProjectSubscription[]
  accreditationProjects   AccreditationProject[]
  taskBoards              Board[]

  // Audit
  createdById String
  createdBy   User     @relation("ProjectCreator", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([status])
  @@index([code])
  @@index([managerId])
  @@index([startDate, endDate])
}

// ─────────────────────────────────────────────────────────────────
// BUDGET CATEGORIES - Top level groupings (A, B, C, D, E, F)
// ─────────────────────────────────────────────────────────────────

model ProjectBudgetCategory {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  code        String // "A", "B", "C", etc.
  name        String // "Lighting Production and Special Effects"
  description String?
  sortOrder   Int     @default(0)

  // Category-level budget allocation
  budgetedRevenue Decimal? @db.Decimal(12, 2) // Revenue expected from this category
  budgetedCost    Decimal? @db.Decimal(12, 2) // Cost budget for this category

  items ProjectBudgetItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([projectId, code])
  @@index([projectId])
}

// ─────────────────────────────────────────────────────────────────
// BUDGET LINE ITEMS - Individual expenses (A1, B1, B2, F15, etc.)
// ─────────────────────────────────────────────────────────────────

model ProjectBudgetItem {
  id         String                 @id @default(cuid())
  projectId  String
  project    Project                @relation(fields: [projectId], references: [id], onDelete: Cascade)
  categoryId String?
  category   ProjectBudgetCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Identification
  costCode    String // "A1", "B3", "F15"
  description String // "Haze machine and operator"
  sortOrder   Int    @default(0)

  // Budget vs Actual
  budgetedAmount  Decimal? @db.Decimal(12, 2)
  actualAmount    Decimal? @db.Decimal(12, 2)
  currency        String   @default("QAR")
  actualAmountQAR Decimal? @db.Decimal(12, 2)

  // Supplier & Procurement
  supplierId   String?
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  supplierName String? // Manual entry if not in Supplier table

  // Link to Purchase Request (optional)
  purchaseRequestId String?
  purchaseRequest   PurchaseRequest? @relation(fields: [purchaseRequestId], references: [id])

  // Procurement references
  prNumber      String? // "BCE-PRF-25-038"
  lpoNumber     String? // "BCE-PO-25/007"
  invoiceNumber String? // "INV-MPQ/0358/2025"

  // Payment tracking
  payments      ProjectPayment[]
  paymentStatus PaymentStatus    @default(PENDING)

  // Status
  status BudgetItemStatus @default(DRAFT)

  // Notes and attachments
  notes         String?
  attachmentUrl String?

  // Audit
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([projectId, costCode])
  @@index([projectId])
  @@index([categoryId])
  @@index([paymentStatus])
  @@index([status])
}

// ─────────────────────────────────────────────────────────────────
// PAYMENT TRANCHES - Multi-payment support (P1, P2, P3)
// ─────────────────────────────────────────────────────────────────

model ProjectPayment {
  id           String            @id @default(cuid())
  budgetItemId String
  budgetItem   ProjectBudgetItem @relation(fields: [budgetItemId], references: [id], onDelete: Cascade)

  // Payment details
  tranche    Int // 1, 2, 3 (P1, P2, P3)
  amount     Decimal  @db.Decimal(12, 2)
  currency   String   @default("QAR")
  amountQAR  Decimal  @db.Decimal(12, 2)
  percentage Decimal? @db.Decimal(5, 2) // 50%, 100%

  // Dates
  dueDate  DateTime?
  paidDate DateTime?
  status   PaymentTrancheStatus @default(PENDING)

  // Bank details
  bankIban      String?
  bankName      String?
  bankSwift     String?
  accountNumber String?
  paymentMethod String? // "QIIB - TT", "ARB - Bank Authorization", "Paid by BCE CC"

  // Reference
  reference String?
  notes     String?

  // Audit
  createdById String?
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([budgetItemId, tranche])
  @@index([budgetItemId])
  @@index([status])
  @@index([paidDate])
}

// ─────────────────────────────────────────────────────────────────
// PROJECT REVENUE - Income tracking (invoices to client)
// ─────────────────────────────────────────────────────────────────

model ProjectRevenue {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  description   String
  invoiceNumber String?
  amount        Decimal @db.Decimal(12, 2)
  currency      String  @default("QAR")
  amountQAR     Decimal @db.Decimal(12, 2)

  invoiceDate DateTime?
  dueDate     DateTime?
  paidDate    DateTime?
  status      RevenueStatus @default(DRAFT)

  attachmentUrl String?
  notes         String?

  // Audit
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([invoiceDate])
}

// ─────────────────────────────────────────────────────────────────
// JUNCTION TABLES - Link standalone modules to projects
// ─────────────────────────────────────────────────────────────────

// Asset allocation to projects (assets remain standalone)
model ProjectAsset {
  id        String  @id @default(cuid())
  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assetId   String
  asset     Asset   @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // How to calculate cost for this project
  costType        AssetCostType @default(FULL_VALUE)
  customAmount    Decimal?      @db.Decimal(12, 2) // If CUSTOM
  customAmountQAR Decimal?      @db.Decimal(12, 2)

  // Allocation period
  startDate DateTime?
  endDate   DateTime?

  notes String?

  // Audit
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@unique([projectId, assetId])
  @@index([projectId])
  @@index([assetId])
}

// Subscription allocation to projects (with % split)
model ProjectSubscription {
  id             String       @id @default(cuid())
  projectId      String
  project        Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // % of subscription cost allocated to this project
  allocationPercent Decimal @default(100) @db.Decimal(5, 2)

  // Allocation period
  startDate DateTime?
  endDate   DateTime?

  notes String?

  // Audit
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@unique([projectId, subscriptionId])
  @@index([projectId])
  @@index([subscriptionId])
}
